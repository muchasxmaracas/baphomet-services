name: Deployment of Reverse Proxy Config to Linux Server

on:
  push:
    branches: 
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy nginx config to server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            set -euo pipefail

            whoami

            export BASE_DIR="/home/sysadmin/app/"
            export REPO_DIR="baphomet-services"
            export NGINX_CONF="/etc/nginx/sites-available/vault.baphomet.cloud.conf"
            export NGINX_ENABLED="/etc/nginx/sites-enabled/vault.baphomet.cloud.conf"
            export TMP_BACKUP="/etc/nginx/sites-available/vault.baphomet.cloud.conf.bak"

            mkdir -p "$BASE_DIR"
            cd "$BASE_DIR"

            if [[ ! -d $REPO_DIR ]]; then
              git clone https://github.com/muchasxmaracas/baphomet-services.git
            fi

            cd "$REPO_DIR"
            git pull origin main

            echo "Starting config deployment with rollback support..."

            # ----------------------------------------------------
            # 1. Handle existing config or first-time deployment
            # ----------------------------------------------------
            FIRST_DEPLOY=false
            if [[ -f "$NGINX_CONF" ]]; then
              echo "Existing nginx config found. Creating backup..."
              sudo cp "$NGINX_CONF" "$TMP_BACKUP"
            else
              echo "⚠ No existing nginx config found — this is the first deployment."
              FIRST_DEPLOY=true
            fi

            # Copy new config
            sudo cp "proxy/vault.baphomet.cloud.conf" "$NGINX_CONF"
            sudo ln -sf "$NGINX_CONF" "$NGINX_ENABLED"

            # ----------------------------------------------------
            # 2. Test new config & try restart
            # ----------------------------------------------------
            echo "Testing new nginx configuration..."
            if ! sudo nginx -t; then
              echo "❌ New config failed validation."
              if [[ "$FIRST_DEPLOY" = true ]]; then
                echo "Removing newly created config (first deploy rollback)..."
                sudo rm -f "$NGINX_CONF"
                sudo rm -f "$NGINX_ENABLED"
              else
                echo "Restoring backup..."
                sudo cp "$TMP_BACKUP" "$NGINX_CONF"
                sudo ln -sf "$NGINX_CONF" "$NGINX_ENABLED"
                sudo nginx -t
              fi
              exit 1
            fi

            echo "Restarting nginx..."
            if ! sudo systemctl restart nginx; then
              echo "❌ Restart failed."
              if [[ "$FIRST_DEPLOY" = true ]]; then
                echo "Removing newly created config (first deploy rollback)..."
                sudo rm -f "$NGINX_CONF"
                sudo rm -f "$NGINX_ENABLED"
              else
                echo "Restoring backup..."
                sudo cp "$TMP_BACKUP" "$NGINX_CONF"
                sudo ln -sf "$NGINX_CONF" "$NGINX_ENABLED"
                sudo nginx -t
                sudo systemctl restart nginx
              fi
              exit 1
            fi

            echo "✅ Deployment successful."

